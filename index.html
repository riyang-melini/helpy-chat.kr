<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <title>Helpy Chatbot</title>
    <link rel="stylesheet" href="https://pyscript.net/releases/2024.1.1/core.css">
    <script type="module" src="https://pyscript.net/releases/2024.1.1/core.js"></script>
    <style>
        body { font-family: 'Pretendard', sans-serif; background-color: #f0f2f5; display: flex; justify-content: center; align-items: center; height: 100vh; margin: 0; }
        .chat-card { width: 400px; height: 600px; background: white; border-radius: 20px; box-shadow: 0 10px 25px rgba(0,0,0,0.1); display: flex; flex-direction: column; overflow: hidden; }
        .header { background: #007bff; color: white; padding: 20px; text-align: center; font-weight: bold; font-size: 1.2rem; }
        #chat-history { flex: 1; overflow-y: auto; padding: 20px; display: flex; flex-direction: column; gap: 10px; background: #fafafa; }
        .input-area { display: flex; padding: 15px; border-top: 1px solid #eee; }
        input { flex: 1; padding: 12px; border: 1px solid #ddd; border-radius: 25px; outline: none; padding-left: 20px; }
        button { background: #007bff; color: white; border: none; border-radius: 50%; width: 40px; height: 40px; margin-left: 10px; cursor: pointer; transition: 0.3s; }
        button:hover { background: #0056b3; }
        .msg { padding: 10px 15px; border-radius: 18px; max-width: 75%; font-size: 0.95rem; line-height: 1.4; }
        .user-msg { align-self: flex-end; background: #007bff; color: white; border-bottom-right-radius: 2px; }
        .bot-msg { align-self: flex-start; background: #e9ecef; color: #333; border-bottom-left-radius: 2px; }
        #loading { font-size: 0.8rem; color: #888; text-align: center; padding: 5px; }
    </style>
</head>
<body>

<div class="chat-card">
    <div class="header">Helpy Chatbot</div>
    <div id="chat-history">
        <div class="msg bot-msg">AI 모델을 로딩 중입니다... 잠시만 기다려주세요. (약 30초 소요)</div>
    </div>
    <div id="loading"></div>
    <div class="input-area">
        <input type="text" id="user-input" placeholder="메시지를 입력하세요..." onkeypress="if(event.keyCode==13) document.getElementById('send-btn').click()">
        <button id="send-btn" py-click="chat_logic">➔</button>
    </div>
</div>

<section class="pyscript">
    <script type="py" config>
        packages = ["pandas", "sentence-transformers", "scikit-learn"]
    </script>
    <script type="py">
        from pyscript import display, document
        import pandas as pd
        from sentence_transformers import SentenceTransformer
        from sklearn.metrics.pairwise import cosine_similarity
        import datetime

        # 1. 모델 로드
        model = SentenceTransformer('jhgan/ko-sroberta-multitask')

        # 2. 데이터 준비 (CSV 파일을 찾을 수 없을 때를 대비한 기본 데이터셋)
        # 실제 배포시에는 같은 경로에 csv를 두고 pd.read_csv('파일명.csv')를 사용하세요.
        try:
            df = pd.read_csv('helpy 발화 - 시트1.csv') # 파일명을 본인의 csv 파일명으로 바꾸세요.
        except:
            data = {
                '사용자 발화': ['안녕', '이름이 뭐야', '도와줘'],
                '챗봇 발화': ['안녕하세요! 무엇을 도와드릴까요?', '저는 Helpy 챗봇입니다.', '어떤 도움이 필요하신가요?']
            }
            df = pd.DataFrame(data)

        df = df[~df['챗봇 발화'].isna()]
        df['embedding'] = df['사용자 발화'].map(lambda x: list(model.encode(str(x))))

        # 초기 메시지 변경
        document.querySelector("#chat-history").innerHTML = '<div class="msg bot-msg">준비가 완료되었습니다! 대화를 시작해보세요.</div>'

        async def chat_logic(event):
            input_box = document.querySelector("#user-input")
            text = input_box.value.strip()
            if not text: return
            
            add_message(text, "user-msg")
            input_box.value = ""

            # 종료 조건
            if text.lower() in ['잘있어', 'break']:
                response = 'Helpy: 안녕히 가세요!'
            # 시간 조건
            elif '시간' in text:
                response = f"현재 시간은 {datetime.datetime.now().strftime('%H:%M')}예요!"
            # 유사도 검색
            else:
                embedding = model.encode(text)
                df['distance'] = df['embedding'].map(lambda x: cosine_similarity([embedding], [x]).squeeze())
                answer = df.loc[df['distance'].idxmax()]

                if answer['distance'] >= 0.6:
                    response = f"{answer['챗봇 발화']}"
                else:
                    response = "모르겠어요, 아직 학습되지 않았나봐요."

            add_message(response, "bot-msg")

        def add_message(content, class_name):
            history = document.querySelector("#chat-history")
            new_msg = document.createElement("div")
            new_msg.className = f"msg {class_name}"
            new_msg.innerText = content
            history.appendChild(new_msg)
            history.scrollTop = history.scrollHeight
    </script>
</section>

</body>
</html>
